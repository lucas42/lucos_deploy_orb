description: "Calculates version, tags the repo, and halts if no release is needed."
steps:
  - run:
      name: Generate Semantic Release Config
      command: |
        cat \<< 'EOF' > .releaserc.json
        {
          "plugins": [
            "@semantic-release/commit-analyzer",
            "@semantic-release/release-notes-generator",
            ["@semantic-release/exec", {
              "prepareCmd": "echo 'export NEXT_VERSION=${nextRelease.version}' >> $BASH_ENV"
            }],
            "@semantic-release/github"
          ]
        }
        EOF
  - run:
    name: Token Check
    command: |
      source $BASH_ENV
      if [ -z "$GITHUB_TOKEN" ]; then
        echo "GITHUB_TOKEN is NOT set. Check this is configured correctly in lucos_creds"
        exit 1
      else
        echo "GITHUB_TOKEN is set (Length: ${#GITHUB_TOKEN})"
      fi
  - run:
      name: Run Semantic Release
      command: |
        source $BASH_ENV
        # Explicitly request both the main tool and the exec plugin
        npx --package semantic-release --package @semantic-release/exec semantic-release
  - run:
      name: Halt if no release
      command: |
        source $BASH_ENV
        if [ -z "$NEXT_VERSION" ]; then
          echo "No release-worthy changes detected. Halting job."
          circleci-agent step halt
        fi
