description: "Calculates version, tags the repo, and halts if no release is needed."
steps:
  - run:
      name: Generate Semantic Release Config
      command: |
        cat \<< 'EOF' > .releaserc.json
        {
          "plugins": [
            "@semantic-release/commit-analyzer",
            "@semantic-release/release-notes-generator",
            ["@semantic-release/exec", {
              "prepareCmd": "echo 'export NEXT_VERSION=${nextRelease.version}' >> $BASH_ENV"
            }],
            "@semantic-release/github"
          ]
        }
        EOF
  - run:
      name: Token Check
      command: |
        source $BASH_ENV
        if [ -z "$GITHUB_TOKEN" ]; then
          echo "GITHUB_TOKEN is NOT set. Check this is configured correctly in lucos_creds"
          exit 1
        else
          echo "GITHUB_TOKEN is set (Length: ${#GITHUB_TOKEN})"
        fi
  - run:
      name: Run Semantic Release
      command: |
        source $BASH_ENV
        # 1. Ensure the token is exported to child processes
        export GITHUB_TOKEN=$GITHUB_TOKEN

        # 2. Tell Git to use the token for this repository URL
        # This overrides the SSH deploy key and forces HTTPS with the token
        git config remote.origin.url "https://x-access-token:${GITHUB_TOKEN}@github.com/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}.git"

        # 3. Run the tool
        npx --package semantic-release --package @semantic-release/exec semantic-release
  - run:
      name: Halt if no release
      command: |
        source $BASH_ENV
        if [ -z "$NEXT_VERSION" ]; then
          echo "No release-worthy changes detected. Halting job."
          circleci-agent step halt
        fi
