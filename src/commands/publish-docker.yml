description: "Builds and pushes all images defined in docker-compose."
steps:
  - setup_remote_docker
  - run:
      name: Docker Login
      command: |
        source $BASH_ENV
        echo "$DOCKERHUB_ACCESS_TOKEN" | docker login --username "$DOCKERHUB_USERNAME" --password-stdin
  - run:
      name: Docker Build & Push (Versioned)
      command: |
        source $BASH_ENV
        VERSION=$NEXT_VERSION docker compose build
        VERSION=$NEXT_VERSION docker compose push
  - run:
      name: Docker Tag & Push (Latest)
      command: |
        source $BASH_ENV
        VERSION=latest docker compose build
        VERSION=latest docker compose push