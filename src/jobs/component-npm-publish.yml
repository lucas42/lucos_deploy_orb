docker:
  - image: cimg/node:current

steps:
  - checkout
  - run:
      name: Install dependencies
      command: npm install

  - run:
      name: Build component
      command: |
        npm run build

  - fetch-publish-creds
  - run:
      name: Publish to NPM
      command: |
        npm set //registry.npmjs.org/:_authToken=$NPM_TOKEN
        npm publish

  - run:
      name: Send publish log to loganne
      command: |
        VERSION=$(npm pkg get version | sed s/\"//g)
        curl https://loganne.l42.eu/events --data '{
          "type":"publishedComponent",
          "source":"lucos_deploy_orb",
          "componentDeployed":"'$CIRCLE_PROJECT_REPONAME'",
          "humanReadable":"Published version '$VERSION' of component '$CIRCLE_PROJECT_REPONAME' to npm",
          "version": "'$VERSION'"
        }' -H "Content-Type: application/json" --fail
